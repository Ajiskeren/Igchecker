<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IG Pro Checker</title>
    <style>
        /* CSS SEDERHANA & BERSIH */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #fafafa; margin: 0; padding: 20px; color: #262626; }
        .container { max-width: 500px; margin: auto; background: white; border-radius: 8px; border: 1px solid #dbdbdb; overflow: hidden; }
        
        .search-area { padding: 20px; text-align: center; border-bottom: 1px solid #efefef; }
        input { padding: 10px; width: 60%; border: 1px solid #dbdbdb; border-radius: 4px; background: #fafafa; }
        button#btnCek { padding: 10px 20px; background: #0095f6; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; }
        button#btnCek:disabled { opacity: 0.7; cursor: not-allowed; }

        .profile-header { padding: 20px; display: flex; align-items: center; border-bottom: 1px solid #efefef; }
        .pp { width: 77px; height: 77px; border-radius: 50%; margin-right: 20px; border: 1px solid #dbdbdb; }
        .stats { display: flex; gap: 15px; margin: 10px 0; font-size: 14px; }
        .bio { font-size: 14px; white-space: pre-wrap; }

        .tabs { display: flex; border-bottom: 1px solid #dbdbdb; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; color: #8e8e8e; border-bottom: 2px solid transparent; font-weight: 600; font-size: 14px;}
        .tab.active { color: #262626; border-bottom: 2px solid #262626; }

        .content { display: none; padding: 0; }
        .content.active { display: block; }

        /* POST GRID */
        .post-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; padding: 3px; }
        .post-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; cursor: pointer; }
        
        /* LIST FOLLOWERS */
        .user-list { list-style: none; padding: 0; margin: 0; }
        .user-item { display: flex; justify-content: space-between; padding: 10px 20px; align-items: center; border-bottom: 1px solid #fafafa; }
        .user-item a { text-decoration: none; color: #0095f6; font-weight: 600; font-size: 12px; }

        .load-more-btn { width: 100%; padding: 15px; background: white; border: none; color: #0095f6; font-weight: bold; cursor: pointer; border-top: 1px solid #efefef; }
        .load-more-btn:hover { background: #fafafa; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="search-area">
        <input type="text" id="username" placeholder="Username...">
        <button id="btnCek" onclick="startCheck()">Cek Akun</button>
        <div id="status" style="margin-top:10px; font-size:12px; color:gray;"></div>
    </div>

    <div id="result" class="hidden">
        <div class="profile-header">
            <img id="pp" class="pp" src="">
            <div>
                <h3 id="fname" style="margin:0; font-size:16px;">Name</h3>
                <div style="color:gray; font-size:14px; margin-bottom:5px;" id="uname">@username</div>
                <div class="stats">
                    <span><b id="s_posts">0</b> posts</span>
                    <span><b id="s_followers">0</b> followers</span>
                    <span><b id="s_following">0</b> following</span>
                </div>
                <div class="bio" id="bio"></div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="openTab('posts')">POSTS</div>
            <div class="tab" onclick="openTab('followers')">FOLLOWERS</div>
            <div class="tab" onclick="openTab('following')">FOLLOWING</div>
        </div>

        <!-- POSTS TAB -->
        <div id="view-posts" class="content active">
            <div class="post-grid" id="grid-posts"></div>
        </div>

        <!-- FOLLOWERS TAB -->
        <div id="view-followers" class="content">
            <div class="user-list" id="list-followers"></div>
            <button class="load-more-btn hidden" id="btn-more-followers" onclick="loadMore('followers')">Muat Lebih Banyak...</button>
        </div>

        <!-- FOLLOWING TAB -->
        <div id="view-following" class="content">
            <div class="user-list" id="list-following"></div>
            <button class="load-more-btn hidden" id="btn-more-following" onclick="loadMore('following')">Muat Lebih Banyak...</button>
        </div>
    </div>
</div>

<script>
    // Variabel Global untuk menyimpan data
    let allFollowers = [];
    let allFollowing = [];
    let indexFollowers = 0;
    let indexFollowing = 0;
    const LIMIT_PER_PAGE = 10;

    async function startCheck() {
        const user = document.getElementById('username').value;
        if (!user) return;

        // Reset UI
        document.getElementById('status').innerText = "⏳ Sedang mengambil data (bisa sampai 10 detik)...";
        document.getElementById('result').classList.add('hidden');
        document.getElementById('btnCek').disabled = true;

        try {
            const req = await fetch('/api/check', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: user})
            });
            const data = await req.json();

            if (data.status !== 'success') {
                document.getElementById('status').innerText = "❌ Gagal: " + (data.message || "Unknown Error");
                document.getElementById('btnCek').disabled = false;
                return;
            }

            document.getElementById('status').innerText = "";
            renderProfile(data);
        } catch (e) {
            document.getElementById('status').innerText = "❌ Error Koneksi";
        } finally {
            document.getElementById('btnCek').disabled = false;
        }
    }

    function renderProfile(data) {
        const u = data.user;
        document.getElementById('pp').src = u.profile_pic;
        document.getElementById('fname').innerText = u.full_name;
        document.getElementById('uname').innerText = "@" + u.username + (u.is_verified ? " ☑️" : "");
        document.getElementById('bio').innerText = u.biography;
        document.getElementById('s_posts').innerText = u.media_count;
        document.getElementById('s_followers').innerText = u.followers_count;
        document.getElementById('s_following').innerText = u.following_count;

        // Render Posts (Grid)
        const postDiv = document.getElementById('grid-posts');
        postDiv.innerHTML = "";
        data.posts.forEach(p => {
            postDiv.innerHTML += `<a href="${p.link}" target="_blank"><img src="${p.thumbnail}" class="post-img" title="${p.caption}"></a>`;
        });
        if(data.posts.length === 0) postDiv.innerHTML = "<div style='padding:20px; grid-column:span 3; text-align:center'>Tidak ada postingan / Private</div>";

        // Siapkan Data Followers & Following
        allFollowers = data.followers;
        allFollowing = data.following;
        indexFollowers = 0;
        indexFollowing = 0;

        // Render Awal (10 Pertama)
        document.getElementById('list-followers').innerHTML = "";
        document.getElementById('list-following').innerHTML = "";
        
        loadMore('followers');
        loadMore('following');

        document.getElementById('result').classList.remove('hidden');
    }

    function loadMore(type) {
        let sourceData, currentIndex, containerId, btnId;

        if (type === 'followers') {
            sourceData = allFollowers;
            currentIndex = indexFollowers;
            containerId = 'list-followers';
            btnId = 'btn-more-followers';
        } else {
            sourceData = allFollowing;
            currentIndex = indexFollowing;
            containerId = 'list-following';
            btnId = 'btn-more-following';
        }

        const container = document.getElementById(containerId);
        const btn = document.getElementById(btnId);
        
        // Ambil slice data berikutnya
        const nextBatch = sourceData.slice(currentIndex, currentIndex + LIMIT_PER_PAGE);
        
        if (nextBatch.length === 0 && currentIndex === 0) {
            container.innerHTML = "<div style='padding:20px; text-align:center; color:gray'>Data tidak tersedia / Private</div>";
            btn.classList.add('hidden');
            return;
        }

        nextBatch.forEach(u => {
            container.innerHTML += `
                <li class="user-item">
                    <div>
                        <div style="font-weight:600">${u.username}</div>
                        <div style="font-size:12px; color:gray">${u.full_name}</div>
                    </div>
                    <a href="${u.link}" target="_blank">Lihat</a>
                </li>
            `;
        });

        // Update Index
        if (type === 'followers') indexFollowers += nextBatch.length;
        else indexFollowing += nextBatch.length;

        // Cek apakah tombol Load More masih perlu muncul
        if ((type === 'followers' ? indexFollowers : indexFollowing) >= sourceData.length) {
            btn.classList.add('hidden');
        } else {
            btn.classList.remove('hidden');
            btn.innerText = `Muat Lebih Banyak (${sourceData.length - (type === 'followers' ? indexFollowers : indexFollowing)} tersisa)`;
        }
    }

    function openTab(tabName) {
        document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        
        document.getElementById('view-' + tabName).classList.add('active');
        // Hacky way to highlight tab button text, better use IDs
        event.target.classList.add('active');
    }
</script>

</body>
</html>


